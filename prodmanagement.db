import sqlite3

def get_db_connection():
    """Create and return a database connection"""
    conn = sqlite3.connect('store.db')
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Initialize database with sample products if empty"""
    conn = get_db_connection()
    conn.execute('''
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            brand TEXT NOT NULL,
            price REAL NOT NULL,
            stock INTEGER DEFAULT 0,
            image TEXT,
            description TEXT,
            nutritional TEXT,
            ingredients TEXT,
            allergens TEXT,
            dimensions TEXT,
            vegan INTEGER DEFAULT 0,
            halal INTEGER DEFAULT 0,
            beef INTEGER DEFAULT 0,
            gluten_free INTEGER DEFAULT 0
        )
    ''')
    
    count = conn.execute('SELECT COUNT(*) FROM products').fetchone()[0]
    if count == 0:
        sample_products = [
            ("Blueberry Granola", "Nature's Best", 29.99, 156, 'blueberry_granola.png',
             'A delicious and nutritious granola made with real blueberries.', 
             'Energy: 420 kcal per 100g | Protein: 9g', 'Whole grain oats, blueberries',
             'Contains: Tree nuts', 'Weight: 500g', 0, 1, 0, 0),
            ("Strawberry Jam", "Orchard Fresh", 59.99, 89, 'strawberry_jam.png',
             'Premium strawberry jam.', 'Energy: 250 kcal per 100g',
             'Strawberries, sugar', 'None', 'Weight: 340g', 1, 1, 0, 1),
        ]
        conn.executemany('''
            INSERT INTO products (name, brand, price, stock, image, description,
            nutritional, ingredients, allergens, dimensions, vegan, halal, beef, gluten_free)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', sample_products)
        conn.commit()
    conn.close()


class Product:
    """Product model class"""
    def __init__(self, id=None, name='', brand='', price=0.0, stock=0, image='',
                 description='', nutritional='', ingredients='', allergens='',
                 dimensions='', vegan=0, halal=0, beef=0, gluten_free=0):
        self.id = id
        self.name = name
        self.brand = brand
        self.price = price
        self.stock = stock
        self.image = image
        self.description = description
        self.nutritional = nutritional
        self.ingredients = ingredients
        self.allergens = allergens
        self.dimensions = dimensions
        self.vegan = vegan
        self.halal = halal
        self.beef = beef
        self.gluten_free = gluten_free
    
    def save(self):
        """Create or Update product in database"""
        conn = get_db_connection()
        if self.id:
            # UPDATE existing product
            conn.execute('''
                UPDATE products SET name=?, brand=?, price=?, stock=?, image=?,
                description=?, nutritional=?, ingredients=?, allergens=?,
                dimensions=?, vegan=?, halal=?, beef=?, gluten_free=?
                WHERE id=?
            ''', (self.name, self.brand, self.price, self.stock, self.image,
                  self.description, self.nutritional, self.ingredients, self.allergens,
                  self.dimensions, self.vegan, self.halal, self.beef, self.gluten_free, self.id))
        else:
            # CREATE new product
            conn.execute('''
                INSERT INTO products (name, brand, price, stock, image, description,
                nutritional, ingredients, allergens, dimensions, vegan, halal, beef, gluten_free)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (self.name, self.brand, self.price, self.stock, self.image,
                  self.description, self.nutritional, self.ingredients, self.allergens,
                  self.dimensions, self.vegan, self.halal, self.beef, self.gluten_free))
        conn.commit()
        conn.close()
    
    def delete(self):
        """Delete product from database"""
        if self.id:
            conn = get_db_connection()
            conn.execute('DELETE FROM products WHERE id=?', (self.id,))
            conn.commit()
            conn.close()
    
    @staticmethod
    def get_all():
        """Retrieve all products"""
        conn = get_db_connection()
        products_raw = conn.execute('SELECT * FROM products ORDER BY id').fetchall()
        conn.close()
        
        products = []
        for p in products_raw:
            product = Product(
                id=p['id'], name=p['name'], brand=p['brand'],
                price=p['price'], stock=p['stock'], image=p['image'],
                description=p['description'], nutritional=p['nutritional'],
                ingredients=p['ingredients'], allergens=p['allergens'],
                dimensions=p['dimensions'], vegan=p['vegan'],
                halal=p['halal'], beef=p['beef'], gluten_free=p['gluten_free']
            )
            products.append(product)
        return products
    
    @staticmethod
    def get_by_id(product_id):
        """Retrieve single product by ID"""
        conn = get_db_connection()
        p = conn.execute('SELECT * FROM products WHERE id=?', (product_id,)).fetchone()
        conn.close()
        
        if p:
            return Product(
                id=p['id'], name=p['name'], brand=p['brand'],
                price=p['price'], stock=p['stock'], image=p['image'],
                description=p['description'], nutritional=p['nutritional'],
                ingredients=p['ingredients'], allergens=p['allergens'],
                dimensions=p['dimensions'], vegan=p['vegan'],
                halal=p['halal'], beef=p['beef'], gluten_free=p['gluten_free']
            )
        return None