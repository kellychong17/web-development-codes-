<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Summary</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f8f8f8; }
        .header { display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; }
        .back-logo { position: absolute; left: 0; display: flex; align-items: center; gap: 10px; }
        .divider { width: 70%; height: 2px; background: #000; margin: 4px auto 20px; }
        .back-button { font-size: 28px; cursor: pointer; text-decoration: none; color: #000; }
        .logo { height: 70px; width: 90px; object-fit: contain; }
        h2 { margin-top: 15px; }
        .cart-box { width: 70%; margin: 0 auto; background: #fff; border: 2px solid #000; border-radius: 6px; padding: 10px; box-sizing: border-box; }
        .item { display: flex; gap: 15px; padding: 10px 0; border-bottom: 1px solid #e6e6e6; position: relative; align-items: center; }
        .item:last-child { border-bottom: none; }
        .item img { width: 65px; height: 65px; object-fit: cover; border-radius: 5px; background: #eee; }
        .promo-row { width: 70%; margin: 14px auto; display: flex; gap: 10px; }
        .promo-row input { flex: 1; padding: 8px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; }
        .promo-row button { padding: 8px 18px; border-radius: 4px; border: 1px solid #000; background: #fff; cursor: pointer; }
        .error-msg { width: 70%; margin: -10px auto 0; color: #d00; font-size: 13px; visibility: hidden; }
        .summary-box { width: 70%; margin: 4px auto; border: 2px solid #000; border-radius: 6px; padding: 10px; background: #fff; box-sizing: border-box; }
        .summary-title { text-align: left; font-weight: 600; padding: 6px 4px; margin-bottom: 6px; }
        .inner-divider { width: 100%; height: 1px; background: #cfcfcf; margin: 6px 0 8px; }
        .row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 15px; }
        .row.small { color: #666; font-size: 14px; }
        .total { font-weight: 700; font-size: 18px; border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
        .checkout { float: right; margin-top: 0; margin-bottom: 10px; font-weight: bold; background: #46923c; color: white; border: 1px solid #000; padding: 8px 20px; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; }
        .checkout:hover { background: #3a7a32; }
    </style>
</head>

<body>

    <div class="header">
        <div class="back-logo">
            <a href="{{ url_for('shopping_cart') }}" class="back-button">&#8592;</a>
            <img src="/image/logo.png" class="logo">
        </div>
        <h2>Order Summary</h2>
    </div>
    <div class="divider"></div>

    <div class="cart-box">
        {% if items %}
            {% for item in items %}
            <div class="item">
                <img src="/image/{{ item.image }}" alt="{{ item.name }}" onerror="this.src='/image/placeholder.jpg'">
                <div style="flex:1">
                    <strong>{{ item.name }} ({{ item.unit }})</strong>
                    <div style="margin-top: 6px;">Quantity: {{ item.quantity }}</div>
                    ${{ "%.2f"|format(item.price * item.quantity) }}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; padding: 20px;">No items in order</p>
        {% endif %}
    </div>

    <div class="promo-row">
        <input id="promo" placeholder="Enter promo code">
        <button onclick="applyPromo()">Apply</button>
    </div>
    <p class="error-msg" id="promoError">Please enter a valid promo code!</p>

    <div class="summary-box">
        <div class="summary-title">Order Summary</div>
        <div class="inner-divider"></div>

        <div class="row">
            <span>Items (<span id="count">{{ items|length if items else 0 }}</span>)</span>
            <span id="itemTotal">${{ "%.2f"|format(items_total) }}</span>
        </div>
        <div class="row small"><span>Others</span><span>$0.00</span></div>
        <div class="row small"><span>Delivery</span><span id="delivery">${{ "%.2f"|format(delivery_fee) }}</span></div>
        <div class="row">
            <span>Subtotal</span>
            <span id="subtotal">${{ "%.2f"|format(items_total + delivery_fee) }}</span>
        </div>
        <div class="row"><span>Discount</span><span id="discount">${{ "%.2f"|format(discount) }}</span></div>
        <div class="row total">
            <span>Total</span>
            <span id="grandTotal">${{ "%.2f"|format(grand_total) }}</span>
        </div>
    </div>

    <a href="{{ url_for('checkout_page') }}" class="checkout">Check Out</a>

    <script>
        let discount = {{ discount|float }};
        const deliveryFee = {{ delivery_fee|float }};
        let itemsTotal = {{ items_total|float }};

        function applyPromo() {
            const code = document.getElementById('promo').value.trim();
            const err = document.getElementById('promoError');

            if (code === 'MEOD10') {
                discount = 10;
                err.style.visibility = 'hidden';

                fetch('/apply-promo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({discount: discount})
                }).then(() => location.reload());
            } else {
                discount = 0;
                err.style.visibility = code ? 'visible' : 'hidden';
                updateTotals();
            }
        }

        function updateTotals() {
            document.getElementById('discount').innerText = `$${discount.toFixed(2)}`;
            const grand = Math.max(0, itemsTotal + deliveryFee - discount);
            document.getElementById('grandTotal').innerText = `$${grand.toFixed(2)}`;
        }
    </script>
</body>

</html>
